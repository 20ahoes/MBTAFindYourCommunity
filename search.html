<!-- search.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>MBTA Municipalities Explorer</title>
  <!-- … your existing <link> and <style> … -->
</head>
<body>

  <!-- Intro Overlay, legend, info panel, etc. all unchanged … -->

  <div id="container">
    <!-- … legendMap, infoPanel, main/search layout … -->
    <div id="main">
      <div class="search-panel">
        <div class="input-wrapper">
          <input type="text" id="townSearch" placeholder="Enter Town Name"/>
          <button id="clearInput" aria-label="Clear input">✕</button>
        </div>
        <button id="doSearch">Search</button>
      </div>
      <iframe
        id="mapFrame"
        src="map_with_button.html?cachebust=8"
        title="Map View"
      ></iframe>
    </div>
  </div>

  <script>
    const intro     = document.getElementById('introOverlay'),
          startBtn  = document.getElementById('startButton'),
          container = document.getElementById('container'),
          mapFrame  = document.getElementById('mapFrame'),
          input     = document.getElementById('townSearch'),
          btnSearch = document.getElementById('doSearch'),
          btnClear  = document.getElementById('clearInput'),
          btnClose  = document.getElementById('closePanel');

    // hide intro
    startBtn.addEventListener('click', () => {
      intro.style.display = 'none';
    });

    // clear everything: collapse panel, clear input, notify child
    function clearAll() {
      input.value = '';
      toggleClearIcon();
      container.classList.remove('info-open');
      mapFrame.contentWindow.postMessage({ type: 'clear-request' }, '*');
    }

    // send search command
    function runSearch() {
      const name = input.value.trim();
      if (!name) return;
      mapFrame.contentWindow.postMessage({ type: 'search-town', name }, '*');
    }

    btnSearch.addEventListener('click', runSearch);
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') runSearch();
      setTimeout(toggleClearIcon, 0);
    });

    function toggleClearIcon() {
      btnClear.style.display = input.value ? 'block' : 'none';
    }
    btnClear.addEventListener('click', clearAll);
    toggleClearIcon();

    btnClose.addEventListener('click', clearAll);

    // only handle messages from our iframe
    window.addEventListener('message', e => {
      if (e.source !== mapFrame.contentWindow) return;
      const msg = e.data;
      if (msg?.type === 'town-selected') {
        const p = msg.properties;
        document.getElementById('townName').textContent  = p.Municipality || 'N/A';
        document.getElementById('areaField').textContent = p.MBTAStationMunicipaliti_Clip1_A || 'N/A';
        document.getElementById('popField').textContent  = p.MBTAStationMunicipaliti_Clip1_P || 'N/A';
        document.getElementById('commField').textContent = p.data0k5Yh_TableToExcel_ExcelT_2 || 'N/A';
        document.getElementById('unitField').textContent = p.data0k5Yh_TableToExcel_ExcelT_3 || 'N/A';
        container.classList.add('info-open');
      }
      else if (msg?.type === 'clear-complete') {
        // child has reset view; nothing more to do
      }
    });
  </script>
</body>
</html>
